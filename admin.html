<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleHealth Admin</title>
    <link id="dynamic-favicon" rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<!-- â”€â”€â”€ LOGIN â”€â”€â”€ -->
<div id="login-shell" class="login-shell">
    <div class="login-card">
        <div class="login-card-icon"><i class="fas fa-shield-halved"></i></div>
        <h2>Admin Portal</h2>
        <p class="sub">Sign in to manage consultations and consent records</p>

        <form id="login-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input id="username" type="text" placeholder="admin" required autocomplete="username" />
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password" />
            </div>
            <div class="error-text" id="login-error"></div>
            <button type="submit" class="btn-primary" style="margin-top:8px;">
                <i class="fas fa-right-to-bracket"></i> Sign In
            </button>
        </form>

        <p class="login-hint">Default: <code style="background:var(--bg-elevated);padding:2px 6px;border-radius:4px;">admin</code> / <code style="background:var(--bg-elevated);padding:2px 6px;border-radius:4px;">admin123</code><br>Set <code>ADMIN_USERNAME</code> &amp; <code>ADMIN_PASSWORD</code> env vars to change.</p>
    </div>
</div>

<!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
<div id="admin-shell" class="admin-shell">

    <!-- Mobile sidebar overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Mobile hamburger toggle -->
    <button id="sidebar-toggle" class="sidebar-hamburger" aria-label="Toggle navigation menu">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="admin-sidebar">
        <div class="sidebar-logo">
            <div class="sidebar-logo-icon" id="sidebar-logo-icon"><i class="fas fa-heartbeat"></i></div>
            <div class="sidebar-logo-text">
                <strong class="dynamic-company-name">TeleHealth Connect</strong>
                <span>Admin Portal</span>
            </div>
        </div>

        <div class="sidebar-section-label">Navigation</div>

        <button class="sidebar-btn active" data-section="overview-section">
            <i class="fas fa-chart-line"></i> Overview
        </button>
        <button class="sidebar-btn" data-section="create-section">
            <i class="fas fa-plus-circle"></i> New Meeting
        </button>
        <button class="sidebar-btn" data-section="meetings-section">
            <i class="fas fa-calendar-check"></i> Meetings
        </button>
        <button class="sidebar-btn" data-section="consents-section">
            <i class="fas fa-file-signature"></i> Consents
        </button>
        <button class="sidebar-btn" data-section="settings-section">
            <i class="fas fa-gear"></i> Settings
        </button>
        <button class="sidebar-btn" data-section="users-section">
            <i class="fas fa-users"></i> Users
        </button>
        <button class="sidebar-btn" data-section="analytics-section">
            <i class="fas fa-chart-bar"></i> Analytics
        </button>
        <button class="sidebar-btn" data-section="security-section">
            <i class="fas fa-lock"></i> Security
        </button>
        <button class="sidebar-btn" data-section="appointments-section">
            <i class="fas fa-calendar-days"></i> Appointments
        </button>
        <button class="sidebar-btn" data-section="patients-section">
            <i class="fas fa-hospital-user"></i> Patients
        </button>

        <div class="sidebar-section-label">Quick Links</div>
        <a href="/" class="sidebar-btn" style="text-decoration:none;display:flex;align-items:center;gap:10px;color:var(--text-2);">
            <i class="fas fa-video"></i> Open App
        </a>
        <a href="/consent" target="_blank" class="sidebar-btn" style="text-decoration:none;display:flex;align-items:center;gap:10px;color:var(--text-2);">
            <i class="fas fa-external-link-alt"></i> Consent Form
        </a>

        <div class="sidebar-spacer"></div>
        <button id="logout-btn" class="sidebar-logout">
            <i class="fas fa-arrow-right-from-bracket"></i> Logout
        </button>
    </aside>

    <!-- Main content -->
    <main class="admin-main">

        <!-- Overview section -->
        <div id="overview-section" class="admin-section active">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Overview</h2>
                    <span>Welcome back, Admin</span>
                </div>
                <div class="admin-topbar-actions">
                    <button class="sidebar-btn" onclick="switchSection('create-section')" style="background:var(--teal);color:#fff;border-color:transparent;gap:6px;">
                        <i class="fas fa-plus"></i> New Meeting
                    </button>
                </div>
            </div>

            <div class="stat-row">
                <div class="stat-card">
                    <div class="stat-icon teal"><i class="fas fa-calendar-check"></i></div>
                    <div class="stat-info">
                        <strong id="stat-meetings">â€”</strong>
                        <span>Total Meetings</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-file-signature"></i></div>
                    <div class="stat-info">
                        <strong id="stat-consents">â€”</strong>
                        <span>Consent Forms</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon amber"><i class="fas fa-clock"></i></div>
                    <div class="stat-info">
                        <strong id="stat-today">&mdash;</strong>
                        <span>Today's Meetings</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon teal" style="background:rgba(124,58,237,.12);color:#a78bfa;"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <strong id="stat-users">&mdash;</strong>
                        <span>Staff / Providers</span>
                    </div>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-card-header">
                    <h3><i class="fas fa-history" style="color:var(--teal);margin-right:8px;"></i>Recent Meetings</h3>
                </div>
                <div id="overview-meetings-list" class="data-list"></div>
            </div>
        </div>

        <!-- Create Meeting section -->
        <div id="create-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Create Meeting</h2>
                    <span>Generate a new secure consultation link</span>
                </div>
            </div>

            <div class="panel-card" style="max-width:600px;">
                <div class="panel-card-header">
                    <h3><i class="fas fa-wand-magic-sparkles" style="color:var(--teal);margin-right:8px;"></i>New Consultation Room</h3>
                </div>
                <div class="form-group">
                    <label>Meeting Topic / Room Name</label>
                    <input type="text" id="room-name" placeholder="e.g. Follow-up Consultation â€” Dr. Smith" />
                </div>                <div class="form-group">
                    <label>Meeting Password <span style="color:var(--text-3);font-weight:400;">(auto-generated if left blank)</span></label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input type="text" id="room-password" placeholder="Leave blank to auto-generate" style="flex:1;font-family:monospace;" />
                        <button type="button" id="gen-pwd-btn" class="secondary-btn" style="padding:10px 13px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg-elevated);color:var(--text-2);font-size:12px;white-space:nowrap;flex-shrink:0;">
                            <i class="fas fa-rotate"></i> Generate
                        </button>
                    </div>
                    <div style="font-size:11px;color:var(--text-3);margin-top:4px;"><i class="fas fa-lock" style="margin-right:4px;"></i>Password is embedded in the patient link automatically.</div>
                </div>                <button id="create-btn" class="btn-primary" style="width:100%;justify-content:center;padding:12px;">
                    <i class="fas fa-link"></i> Generate Meeting Link
                </button>

                <div id="result-area" style="display:none;">
                    <div style="display:flex;flex-direction:column;gap:14px;">
                        <!-- Patient link (goes through consent first) -->
                        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-md);padding:14px 16px;">
                            <div style="font-size:11px;font-weight:600;letter-spacing:.06em;color:var(--teal);margin-bottom:6px;"><i class="fas fa-user-injured" style="margin-right:6px;"></i>PATIENT LINK <span style="color:var(--text-3);font-weight:400;">(includes consent form)</span></div>
                            <div id="patient-link" style="font-size:13px;color:var(--text-2);word-break:break-all;margin-bottom:10px;"></div>
                            <div class="inline-actions">
                                <button id="copy-btn" class="secondary-btn" style="padding:8px 13px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);font-size:12px;gap:6px;">
                                    <i class="fas fa-copy"></i> Copy Patient Link
                                </button>
                            </div>
                        </div>
                        <!-- Meeting password — share separately with the patient -->
                        <div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.25);border-radius:var(--r-md);padding:14px 16px;">
                            <div style="font-size:11px;font-weight:600;letter-spacing:.06em;color:var(--amber,#f59e0b);margin-bottom:6px;"><i class="fas fa-key" style="margin-right:6px;"></i>MEETING PASSWORD <span style="color:var(--text-3);font-weight:400;">(share this with the patient separately)</span></div>
                            <div id="result-password" style="font-size:18px;font-weight:700;letter-spacing:.15em;color:var(--text);font-family:monospace;margin-bottom:10px;"></div>
                            <div class="inline-actions">
                                <button id="copy-pwd-btn" class="secondary-btn" style="padding:8px 13px;border-radius:var(--r-md);border:1px solid rgba(245,158,11,.35);background:var(--bg);color:var(--text-2);font-size:12px;gap:6px;">
                                    <i class="fas fa-copy"></i> Copy Password
                                </button>
                            </div>
                        </div>
                        <!-- Host direct join -->
                        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-md);padding:14px 16px;">
                            <div style="font-size:11px;font-weight:600;letter-spacing:.06em;color:var(--green);margin-bottom:6px;"><i class="fas fa-user-shield" style="margin-right:6px;"></i>HOST LINK <span style="color:var(--text-3);font-weight:400;">(bypasses consent — for providers only)</span></div>
                            <div id="host-link" style="font-size:13px;color:var(--text-2);word-break:break-all;margin-bottom:10px;"></div>
                            <div class="inline-actions">
                                <button id="copy-host-btn" class="secondary-btn" style="padding:8px 13px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);font-size:12px;gap:6px;">
                                    <i class="fas fa-copy"></i> Copy Host Link
                                </button>
                                <button id="join-btn" class="btn-primary" style="padding:8px 13px;font-size:13px;gap:6px;">
                                    <i class="fas fa-external-link-alt"></i> Join Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-card" style="max-width:600px;margin-top:0;">
                <div class="panel-card-header">
                    <h3><i class="fas fa-file-signature" style="color:var(--teal);margin-right:8px;"></i>Patient Consent Form</h3>
                </div>
                <p class="muted" style="margin-bottom:14px;">Send this link to patients before their consultation to collect their digital consent signature.</p>
                <div class="inline-actions">
                    <a href="/consent" target="_blank" class="secondary-btn" style="text-decoration:none;padding:9px 14px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg-elevated);color:var(--text-2);font-size:13px;gap:6px;display:inline-flex;align-items:center;">
                        <i class="fas fa-eye"></i> Preview Form
                    </a>
                    <button onclick="copyConsentLink()" class="secondary-btn" style="padding:9px 14px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg-elevated);color:var(--text-2);font-size:13px;gap:6px;">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>

        <!-- Meetings List section -->
        <div id="meetings-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>All Meetings</h2>
                    <span>History of all created meeting rooms</span>
                </div>
            </div>
            <div class="panel-card">
                <div id="meetings-list" class="data-list"></div>
            </div>
        </div>

        <!-- Consents section -->
        <div id="consents-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Consent Forms</h2>
                    <span>All patient consent submissions</span>
                </div>
            </div>
            <div class="panel-card">
                <div id="consents-list" class="data-list"></div>
            </div>
        </div>

        <!-- Settings section -->
        <div id="settings-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Settings</h2>
                    <span>Customize your organization's information</span>
                </div>
            </div>

            <div class="panel-card" style="max-width:720px;">
                <div class="panel-card-header">
                    <h3><i class="fas fa-sliders" style="color:var(--teal);margin-right:8px;"></i>Organization Settings</h3>
                </div>
                <p class="settings-sub">These settings affect how your organization name and details appear across all pages of the app.</p>

                <div class="settings-grid">
                    <div class="form-group">
                        <label for="cfg-company">Company / Organization Name</label>
                        <input type="text" id="cfg-company" placeholder="TeleHealth Connect" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-tagline">Tagline / Slogan</label>
                        <input type="text" id="cfg-tagline" placeholder="Secure Video Consultations" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-timezone">Timezone</label>
                        <select id="cfg-timezone" class="form-select">
                            <option value="UTC">UTC (UTC+0)</option>
                            <option value="America/New_York">US Eastern / New York (UTC‑5/‑4)</option>
                            <option value="America/Chicago">US Central / Chicago (UTC‑6/‑5)</option>
                            <option value="America/Denver">US Mountain (UTC‑7/‑6)</option>
                            <option value="America/Los_Angeles">US Pacific (UTC‑8/‑7)</option>
                            <option value="Europe/London">Europe/London (UTC+0/+1)</option>
                            <option value="Europe/Paris">Europe/Paris (UTC+1/+2)</option>
                            <option value="Europe/Moscow">Europe/Moscow (UTC+3)</option>
                            <option value="Asia/Dubai">Asia/Dubai (UTC+4)</option>
                            <option value="Asia/Kolkata">Asia/Kolkata (UTC+5:30)</option>
                            <option value="Asia/Manila">Asia/Manila (UTC+8)</option>
                            <option value="Asia/Singapore">Asia/Singapore (UTC+8)</option>
                            <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
                            <option value="Australia/Sydney">Australia/Sydney (UTC+10/+11)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cfg-email">Contact Email</label>
                        <input type="email" id="cfg-email" placeholder="hello@yourpractice.com" />
                    </div>
                    <div class="form-group full">
                        <label for="cfg-phone">Contact Phone</label>
                        <input type="tel" id="cfg-phone" placeholder="+1 (555) 000-0000" />
                    </div>
                    <div class="form-group full">
                        <label for="cfg-logo">Company Logo URL <span style="color:var(--text-3);font-weight:400;">(used in sidebar &amp; browser tab)</span></label>
                        <input type="url" id="cfg-logo" placeholder="https://yoursite.com/logo.png" />
                        <div style="font-size:11px;color:var(--text-3);margin-top:4px;"><i class="fas fa-info-circle" style="margin-right:3px;"></i>Use a direct image URL (PNG/JPG/SVG). Recommended size: 40&times;40px or a square icon.</div>
                        <div id="cfg-logo-preview" style="margin-top:10px;display:none;">
                            <img id="cfg-logo-img" src="" alt="Logo preview" style="height:48px;border-radius:8px;border:1px solid var(--border);padding:4px;background:var(--bg);" />
                        </div>
                    </div>
                </div>

                <!-- Post-Visit Email (SMTP) -->
                <div class="settings-grid" style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
                    <div class="form-group full" style="margin-bottom:6px;">
                        <label style="font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;"><i class="fas fa-envelope" style="color:var(--teal);"></i> Email (SMTP) — Invite &amp; Post-Visit</label>
                        <p style="font-size:12px;color:var(--text-2);margin:4px 0 0;">Used to send consultation invite links to patients and automatic visit summary emails after each call.</p>
                    </div>
                    <div class="form-group">
                        <label for="cfg-smtp-host">SMTP Host</label>
                        <input type="text" id="cfg-smtp-host" placeholder="smtp.gmail.com" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-smtp-port">SMTP Port</label>
                        <input type="number" id="cfg-smtp-port" placeholder="587" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-smtp-user">SMTP Username</label>
                        <input type="text" id="cfg-smtp-user" placeholder="you@gmail.com" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-smtp-pass">SMTP Password / App Password</label>
                        <input type="password" id="cfg-smtp-pass" placeholder="&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;" autocomplete="new-password" />
                    </div>
                    <div class="form-group full">
                        <label for="cfg-smtp-from">From Address <span style="color:var(--text-3);font-weight:400;">(optional)</span></label>
                        <input type="text" id="cfg-smtp-from" placeholder='TeleHealth Connect &lt;you@gmail.com&gt;' />
                        <div style="font-size:11px;color:var(--text-3);margin-top:4px;"><i class="fas fa-info-circle" style="margin-right:3px;"></i>Gmail users: generate an App Password at myaccount.google.com &rarr; Security &rarr; App Passwords.</div>
                    </div>
                </div>

                <!-- SMS (Twilio) -->
                <div class="settings-grid" style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
                    <div class="form-group full" style="margin-bottom:6px;">
                        <label style="font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;"><i class="fas fa-comment-sms" style="color:var(--teal);"></i> SMS (Twilio) — Invite via Text Message</label>
                        <p style="font-size:12px;color:var(--text-2);margin:4px 0 0;">Enter your <a href="https://console.twilio.com" target="_blank" style="color:var(--teal);">Twilio</a> credentials to send consultation invite links by SMS to patients.</p>
                    </div>
                    <div class="form-group">
                        <label for="cfg-twilio-sid">Account SID</label>
                        <input type="text" id="cfg-twilio-sid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-twilio-token">Auth Token</label>
                        <input type="password" id="cfg-twilio-token" placeholder="&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;" autocomplete="new-password" />
                    </div>
                    <div class="form-group">
                        <label for="cfg-twilio-from">Twilio Phone Number <span style="color:var(--text-3);font-weight:400;">(E.164 format)</span></label>
                        <input type="text" id="cfg-twilio-from" placeholder="+15550001234" />
                    </div>
                </div>

                <div class="settings-save-row">
                    <button id="save-settings-btn" class="btn-primary" style="gap:8px;">
                        <i class="fas fa-floppy-disk"></i> Save Settings
                    </button>
                    <span class="save-hint" id="settings-hint"></span>
                </div>
            </div>
        </div>

        <!-- Users section -->
        <div id="users-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Users</h2>
                    <span>Manage staff and provider profiles</span>
                </div>
                <div class="admin-topbar-actions">
                    <button class="sidebar-btn" onclick="openUserModal()" style="background:var(--teal);color:#fff;border-color:transparent;gap:6px;">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
            </div>
            <div id="users-grid" class="users-grid"></div>
        </div>

        <!-- Security / Change Password section -->
        <div id="security-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Security</h2>
                    <span>Change your admin panel password</span>
                </div>
            </div>
            <div class="settings-card" style="max-width:460px;">
                <h3><i class="fas fa-key" style="color:var(--teal);margin-right:8px;"></i>Change Password</h3>
                <p class="settings-sub" style="margin-bottom:20px;">Your new password will be stored securely (scrypt hash) in the database and will override the <code>ADMIN_PASSWORD</code> environment variable.</p>
                <div class="form-group" style="margin-bottom:12px;">
                    <label for="sec-current-pwd">Current Password</label>
                    <input type="password" id="sec-current-pwd" placeholder="Enter current password" autocomplete="current-password" />
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label for="sec-new-pwd">New Password</label>
                    <input type="password" id="sec-new-pwd" placeholder="At least 8 characters" autocomplete="new-password" />
                </div>
                <div class="form-group" style="margin-bottom:20px;">
                    <label for="sec-confirm-pwd">Confirm New Password</label>
                    <input type="password" id="sec-confirm-pwd" placeholder="Repeat new password" autocomplete="new-password" />
                </div>
                <div id="sec-error" style="font-size:13px;color:var(--red,#ef4444);min-height:18px;margin-bottom:12px;"></div>
                <button id="sec-save-btn" class="btn-primary" style="gap:8px;">
                    <i class="fas fa-floppy-disk"></i> Update Password
                </button>
            </div>
        </div>

        <!-- Analytics section -->
        <div id="analytics-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Analytics</h2>
                    <span>Usage statistics from recorded consultations</span>
                </div>
                <div class="admin-topbar-actions">
                    <button class="sidebar-btn" onclick="loadAnalytics()" style="gap:6px;">
                        <i class="fas fa-arrows-rotate"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Date range filter bar -->
            <div class="analytics-filter-bar">
                <div class="analytics-presets">
                    <button class="an-preset active" data-preset="7d"   onclick="setAnalyticsPreset(this)">Last 7 days</button>
                    <button class="an-preset"        data-preset="30d"  onclick="setAnalyticsPreset(this)">Last 30 days</button>
                    <button class="an-preset"        data-preset="90d"  onclick="setAnalyticsPreset(this)">Last 90 days</button>
                    <button class="an-preset"        data-preset="365d" onclick="setAnalyticsPreset(this)">This year</button>
                    <button class="an-preset"        data-preset="all"  onclick="setAnalyticsPreset(this)">All time</button>
                </div>
                <div class="analytics-date-inputs">
                    <div style="display:flex;align-items:center;gap:6px;">
                        <label style="font-size:11px;color:var(--text-2);white-space:nowrap;"><i class="fas fa-calendar" style="color:var(--teal);margin-right:4px;"></i>From</label>
                        <input type="date" id="an-from" onchange="onAnalyticsDateChange()" style="padding:6px 10px;font-size:13px;" />
                    </div>
                    <span style="color:var(--text-2);font-size:13px;">→</span>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <label style="font-size:11px;color:var(--text-2);white-space:nowrap;">To</label>
                        <input type="date" id="an-to" onchange="onAnalyticsDateChange()" style="padding:6px 10px;font-size:13px;" />
                    </div>
                </div>
                <span id="an-range-label" style="font-size:12px;color:var(--text-2);margin-left:4px;"></span>
            </div>

            <!-- KPI Row -->
            <div class="stat-row" id="analytics-kpi-row">
                <div class="stat-card">
                    <div class="stat-icon teal"><i class="fas fa-calendar-check"></i></div>
                    <div class="stat-info"><strong id="an-total">—</strong><span>Total Calls</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-clock"></i></div>
                    <div class="stat-info"><strong id="an-avgdur">—</strong><span>Avg Duration</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon amber"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info"><strong id="an-complete">—</strong><span>Completion Rate</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:rgba(124,58,237,.12);color:#a78bfa;"><i class="fas fa-user-check"></i></div>
                    <div class="stat-info"><strong id="an-returning">—</strong><span>Returning Patients</span></div>
                </div>
            </div>

            <!-- Charts grid -->
            <div class="analytics-charts-grid">
                <div class="panel-card">
                    <div class="panel-card-header"><h3><i class="fas fa-calendar-week" style="color:var(--teal);margin-right:8px;"></i>Calls per Week <span class="analytics-sub">(last 8 weeks)</span></h3></div>
                    <div class="analytics-canvas-wrap"><canvas id="chart-weekly" class="analytics-canvas"></canvas><div id="chart-weekly-empty" class="analytics-empty" style="display:none;">No data yet</div></div>
                </div>
                <div class="panel-card">
                    <div class="panel-card-header"><h3><i class="fas fa-layer-group" style="color:#a78bfa;margin-right:8px;"></i>Duration Distribution</h3></div>
                    <div class="analytics-canvas-wrap"><canvas id="chart-duration" class="analytics-canvas"></canvas><div id="chart-duration-empty" class="analytics-empty" style="display:none;">No data yet</div></div>
                </div>
                <div class="panel-card" style="grid-column:1 / -1;">
                    <div class="panel-card-header"><h3><i class="fas fa-clock" style="color:var(--amber,#f59e0b);margin-right:8px;"></i>Busiest Hours of Day</h3></div>
                    <div class="analytics-canvas-wrap" style="height:160px;"><canvas id="chart-hours" class="analytics-canvas"></canvas><div id="chart-hours-empty" class="analytics-empty" style="display:none;">No data yet</div></div>
                </div>
                <div class="panel-card" style="grid-column:1 / -1;">
                    <div class="panel-card-header"><h3><i class="fas fa-chart-area" style="color:var(--green);margin-right:8px;"></i>Daily Call Volume <span class="analytics-sub">(last 30 days)</span></h3></div>
                    <div class="analytics-canvas-wrap" style="height:160px;"><canvas id="chart-daily" class="analytics-canvas"></canvas><div id="chart-daily-empty" class="analytics-empty" style="display:none;">No data yet</div></div>
                </div>
            </div>
        </div>

        <!-- Appointments section -->
        <div id="appointments-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Appointments</h2>
                    <span>Schedule and manage patient consultations</span>
                </div>
                <div class="admin-topbar-actions">
                    <button class="btn-primary" onclick="openApptModal()" style="gap:6px;">
                        <i class="fas fa-plus"></i> New Appointment
                    </button>
                </div>
            </div>
            <!-- Calendar nav -->
            <div class="panel-card" style="margin-bottom:16px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                    <button onclick="apptMonthShift(-1)" class="secondary-btn" style="padding:7px 14px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="appt-month-label" style="margin:0;font-size:1.05rem;"></h3>
                    <button onclick="apptMonthShift(1)" class="secondary-btn" style="padding:7px 14px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="appt-calendar-header">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <div id="appt-calendar-grid" class="appt-calendar-grid"></div>
            </div>
            <!-- Appointments list for selected day -->
            <div class="panel-card">
                <div class="panel-card-header">
                    <h3><i class="fas fa-list-ul" style="color:var(--teal);margin-right:8px;"></i><span id="appt-list-label">All this month</span></h3>
                </div>
                <div id="appt-list" style="display:flex;flex-direction:column;gap:10px;min-height:60px;">
                    <div class="appt-empty">Select a day or load appointments</div>
                </div>
            </div>
        </div>

        <!-- Patients section -->
        <div id="patients-section" class="admin-section">
            <div class="admin-topbar">
                <div class="admin-topbar-title">
                    <h2>Patient Records</h2>
                    <span>View full history per patient</span>
                </div>
            </div>
            <div class="panel-card" style="margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:0;">
                    <label><i class="fas fa-search" style="margin-right:6px;color:var(--teal);"></i>Search patients</label>
                    <input type="text" id="pt-search" placeholder="Name or email..." oninput="filterPatients()" />
                </div>
            </div>
            <div id="pt-list" class="patients-grid"></div>
            <!-- Patient history slide-in panel -->
            <div id="pt-history-panel" class="pt-history-panel" style="display:none;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
                    <h3 id="pt-history-name" style="margin:0;font-size:1.1rem;"></h3>
                    <button onclick="closePtHistory()" style="background:none;border:none;color:var(--text-2);cursor:pointer;font-size:1.2rem;"><i class="fas fa-times"></i></button>
                </div>
                <div id="pt-history-email" style="font-size:0.85rem;color:var(--text-2);margin-bottom:18px;"></div>
                <div class="pt-history-tabs">
                    <button class="pt-tab active" onclick="switchPtTab('overview')">Overview</button>
                    <button class="pt-tab" onclick="switchPtTab('consents')">Consents</button>
                    <button class="pt-tab" onclick="switchPtTab('visits')">Visits</button>
                    <button class="pt-tab" onclick="switchPtTab('prescriptions')">Prescriptions</button>
                </div>
                <div id="pt-tab-content" style="margin-top:16px;"></div>
            </div>
        </div>

        <footer class="site-footer" style="margin-top:32px;">
            <span class="footer-company dynamic-company-name">TeleHealth Connect</span>
            <span class="footer-sep">&middot;</span>
            <span class="footer-credit">Developed by <strong>Ymath</strong></span>
        </footer>

    </main>
</div>

<div id="toast"></div>

<!-- Appointment Create/Edit Modal -->
<div id="appt-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:2000;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-xl);padding:0;width:100%;max-width:520px;box-shadow:0 24px 60px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto;">

        <!-- Modal header strip -->
        <div style="background:linear-gradient(135deg,rgba(20,184,166,.15) 0%,rgba(99,102,241,.1) 100%);border-bottom:1px solid var(--border);padding:20px 24px;display:flex;justify-content:space-between;align-items:center;border-radius:var(--r-xl) var(--r-xl) 0 0;">
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:36px;height:36px;border-radius:10px;background:rgba(20,184,166,.2);display:flex;align-items:center;justify-content:center;color:var(--teal);font-size:1rem;"><i class="fas fa-calendar-plus"></i></div>
                <div>
                    <h3 id="appt-modal-title" style="margin:0;font-size:1.05rem;font-weight:700;">New Appointment</h3>
                    <p style="margin:2px 0 0;font-size:11px;color:var(--text-2);">Fill in the patient details below</p>
                </div>
            </div>
            <button onclick="closeApptModal()" style="background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text-2);cursor:pointer;font-size:1rem;padding:6px 9px;border-radius:8px;line-height:1;transition:background .15s;" onmouseover="this.style.background='rgba(255,255,255,.12)'" onmouseout="this.style.background='rgba(255,255,255,.06)'"><i class="fas fa-times"></i></button>
        </div>

        <!-- Modal body -->
        <div style="padding:22px 24px 20px;">
            <input type="hidden" id="appt-modal-id" value="" />

            <!-- Patient info -->
            <div style="margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:12px;">
                    <label style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);font-weight:600;">Patient Name <span style="color:#ef4444;">*</span></label>
                    <div style="position:relative;">
                        <i class="fas fa-user" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-2);font-size:13px;pointer-events:none;"></i>
                        <input type="text" id="am-name" placeholder="John Doe" style="padding-left:34px;" />
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group" style="margin:0;">
                        <label style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);font-weight:600;">Email</label>
                        <div style="position:relative;">
                            <i class="fas fa-envelope" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-2);font-size:13px;pointer-events:none;"></i>
                            <input type="email" id="am-email" placeholder="patient@email.com" style="padding-left:34px;" />
                        </div>
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);font-weight:600;">Phone</label>
                        <div style="position:relative;">
                            <i class="fas fa-phone" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-2);font-size:13px;pointer-events:none;"></i>
                            <input type="tel" id="am-phone" placeholder="+1 555 000 0000" style="padding-left:34px;" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Divider -->
            <div style="height:1px;background:var(--border);margin:4px 0 16px;"></div>

            <!-- Date / Time / Duration row -->
            <div style="margin-bottom:16px;">
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);font-weight:600;display:block;margin-bottom:10px;"><i class="fas fa-clock" style="margin-right:5px;color:var(--teal);"></i>Schedule</label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div>
                        <label style="font-size:11px;color:var(--text-2);margin-bottom:5px;display:block;">Date</label>
                        <div style="position:relative;">
                            <i class="fas fa-calendar" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--teal);font-size:13px;pointer-events:none;z-index:1;"></i>
                            <input type="date" id="am-date" style="padding-left:34px;width:100%;box-sizing:border-box;" />
                        </div>
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--text-2);margin-bottom:5px;display:block;">Time</label>
                        <div style="position:relative;">
                            <i class="fas fa-clock" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--teal);font-size:13px;pointer-events:none;z-index:1;"></i>
                            <input type="time" id="am-time" style="padding-left:34px;width:100%;box-sizing:border-box;" />
                        </div>
                    </div>
                </div>
                <!-- Hidden combined datetime field for form submission -->
                <input type="hidden" id="am-datetime" />
                <div style="margin-top:12px;">
                    <label style="font-size:11px;color:var(--text-2);margin-bottom:5px;display:block;">Duration</label>
                    <div style="display:flex;gap:8px;" class="dur-btn-row">
                        <button type="button" class="appt-dur-btn active" data-val="15" onclick="selectDuration(this)">15 min</button>
                        <button type="button" class="appt-dur-btn" data-val="30" onclick="selectDuration(this)">30 min</button>
                        <button type="button" class="appt-dur-btn" data-val="45" onclick="selectDuration(this)">45 min</button>
                        <button type="button" class="appt-dur-btn" data-val="60" onclick="selectDuration(this)">1 hour</button>
                    </div>
                    <input type="hidden" id="am-duration" value="15" />
                </div>
            </div>

            <!-- Divider -->
            <div style="height:1px;background:var(--border);margin:4px 0 16px;"></div>

            <!-- Notes -->
            <div style="margin-bottom:16px;">
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);font-weight:600;display:block;margin-bottom:10px;"><i class="fas fa-notes-medical" style="margin-right:5px;color:#a78bfa;"></i>Visit Notes</label>
                <div style="position:relative;">
                    <textarea id="am-notes" rows="3" placeholder="Reason for visit, chief complaint, special instructions or reminders for the provider…" style="width:100%;box-sizing:border-box;padding:12px 14px;line-height:1.6;resize:vertical;min-height:88px;background:rgba(167,139,250,.04);border:1px solid rgba(167,139,250,.25);border-radius:var(--r-md);color:var(--text);font-family:inherit;font-size:13px;transition:border-color .2s;" onfocus="this.style.borderColor='rgba(167,139,250,.7)'" onblur="this.style.borderColor='rgba(167,139,250,.25)'"></textarea>
                </div>
            </div>

            <!-- Invite toggle -->
            <label style="display:flex;align-items:center;gap:10px;margin-bottom:18px;padding:12px 14px;background:rgba(20,184,166,.05);border:1px solid rgba(20,184,166,.2);border-radius:var(--r-md);cursor:pointer;">
                <div style="position:relative;width:36px;height:20px;flex-shrink:0;">
                    <input type="checkbox" id="am-send-invite" checked style="opacity:0;position:absolute;inset:0;width:100%;height:100%;margin:0;cursor:pointer;z-index:2;" onchange="updateInviteToggle(this)" />
                    <div id="am-invite-track" style="position:absolute;inset:0;border-radius:100px;background:var(--teal);transition:background .2s;"></div>
                    <div id="am-invite-thumb" style="position:absolute;top:2px;left:18px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);"></div>
                </div>
                <div>
                    <div style="font-size:13px;font-weight:600;color:var(--text);">Send invite email to patient</div>
                    <div style="font-size:11px;color:var(--text-2);">Requires SMTP configured in Settings</div>
                </div>
            </label>

            <div id="appt-modal-error" style="color:#ef4444;font-size:13px;margin-bottom:10px;min-height:18px;"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button onclick="closeApptModal()" style="padding:10px 20px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);cursor:pointer;font-size:14px;">Cancel</button>
                <button onclick="saveAppt()" class="btn-primary" style="padding:10px 20px;gap:8px;font-size:14px;">
                    <i class="fas fa-calendar-check"></i> <span id="appt-modal-save-label">Save Appointment</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Add/Edit Modal -->
<div id="user-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:2000;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-xl);padding:28px 28px 22px;width:100%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 id="user-modal-title" style="margin:0;font-size:1.1rem;">Add User</h3>
            <button onclick="closeUserModal()" style="background:none;border:none;color:var(--text-2);cursor:pointer;font-size:1.2rem;padding:4px;"><i class="fas fa-times"></i></button>
        </div>
        <input type="hidden" id="user-modal-id" value="" />
        <div class="form-group">
            <label>Full Name <span style="color:#ef4444;">*</span></label>
            <input type="text" id="um-name" placeholder="Dr. Jane Smith" />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="form-group">
                <label>Role</label>
                <select id="um-role" class="form-select">
                    <option>Doctor</option>
                    <option>Nurse</option>
                    <option>Therapist</option>
                    <option>Specialist</option>
                    <option>Admin</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Specialty</label>
                <input type="text" id="um-specialty" placeholder="e.g. Cardiology" />
            </div>
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="um-email" placeholder="doctor@clinic.com" />
        </div>
        <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="um-phone" placeholder="+1 (555) 000-0000" />
        </div>
        <div class="form-group">
            <label>Bio</label>
            <textarea id="um-bio" rows="3" placeholder="Short professional biography..." style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--r-md);color:var(--text);padding:10px 12px;font-size:13px;resize:vertical;box-sizing:border-box;font-family:inherit;"></textarea>
        </div>
        <div class="form-group">
            <label>Photo URL <span style="color:var(--text-3);font-weight:400;">(optional)</span></label>
            <input type="url" id="um-photo" placeholder="https://..." />
        </div>

        <!-- Credentials divider -->
        <div style="border-top:1px solid var(--border);margin:16px 0 14px;"></div>
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;color:var(--teal);margin-bottom:12px;"><i class="fas fa-key" style="margin-right:5px;"></i>LOGIN CREDENTIALS</div>
        <div class="form-group">
            <label>Username <span style="color:#ef4444;">*</span></label>
            <input type="text" id="um-username" placeholder="dr.smith" autocomplete="off" style="font-family:monospace;" />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="form-group">
                <label id="um-pwd-label">Password <span style="color:#ef4444;">*</span></label>
                <input type="password" id="um-password" autocomplete="new-password" />
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="um-password-confirm" autocomplete="new-password" />
            </div>
        </div>
        <div id="user-modal-error" style="color:#ef4444;font-size:13px;margin-bottom:10px;min-height:18px;"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="closeUserModal()" class="secondary-btn" style="padding:9px 18px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);">Cancel</button>
            <button onclick="saveUser()" class="btn-primary" style="padding:9px 18px;gap:6px;">
                <i class="fas fa-floppy-disk"></i> <span id="user-modal-save-label">Save User</span>
            </button>
        </div>
    </div>
</div>

<script>
    /* â”€â”€â”€ DOM refs â”€â”€â”€ */
    const loginShell  = document.getElementById('login-shell');
    const adminShell  = document.getElementById('admin-shell');
    const loginForm   = document.getElementById('login-form');
    const loginError  = document.getElementById('login-error');
    const logoutBtn   = document.getElementById('logout-btn');
    const createBtn   = document.getElementById('create-btn');
    const roomInput   = document.getElementById('room-name');
    const resultArea  = document.getElementById('result-area');
    const patientLink = document.getElementById('patient-link');
    const hostLink    = document.getElementById('host-link');
    const copyBtn     = document.getElementById('copy-btn');
    const copyHostBtn = document.getElementById('copy-host-btn');
    const joinBtn     = document.getElementById('join-btn');

    /* â”€â”€â”€ Section switching â”€â”€â”€ */
    document.querySelectorAll('.sidebar-btn[data-section]').forEach(btn => {
        btn.addEventListener('click', () => switchSection(btn.dataset.section));
    });

    function switchSection(sectionId) {
        document.querySelectorAll('.sidebar-btn[data-section]').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        const targetBtn = document.querySelector(`.sidebar-btn[data-section="${sectionId}"]`);
        const targetSec = document.getElementById(sectionId);
        if (targetBtn) targetBtn.classList.add('active');
        if (targetSec) targetSec.classList.add('active');
        if (sectionId === 'users-section')         loadUsers();
        if (sectionId === 'analytics-section')  {
            // Set default preset on first open
            const fromEl = document.getElementById('an-from');
            if (fromEl && !fromEl.value) {
                const preset = document.querySelector('.an-preset[data-preset="30d"]');
                if (preset) setAnalyticsPreset(preset);
                else loadAnalytics();
            } else {
                loadAnalytics();
            }
        }
        if (sectionId === 'appointments-section')  loadAppointments();
        if (sectionId === 'patients-section')      loadPatients();
    }

    /* â”€â”€â”€ Auth â”€â”€â”€ */
    loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        loginError.textContent = '';
        try {
            const res = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: document.getElementById('username').value.trim(),
                    password: document.getElementById('password').value
                })
            });
            if (!res.ok) throw new Error('Invalid username or password');
            showDashboard();
        } catch (err) {
            loginError.textContent = err.message;
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await fetch('/api/admin/logout', { method: 'POST' }).catch(() => {});
        adminShell.classList.remove('active');
        loginShell.style.display = 'flex';
        loginForm.reset();
        loginError.textContent = '';
    });

    /* ─── Auth-aware fetch wrapper ─── */
    async function apiFetch(url, opts = {}) {
        const res = await fetch(url, opts);
        if (res.status === 401) {
            showToast('Session expired — please sign in again.');
            setTimeout(() => {
                adminShell.classList.remove('active');
                loginShell.style.display = 'flex';
                loginForm.reset();
                loginError.textContent = 'Your session expired. Please sign in again.';
            }, 800);
            throw new Error('session_expired');
        }
        return res;
    }

    /* Password generator */
    function generatePassword() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        return Array.from({ length: 8 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    document.getElementById('gen-pwd-btn').addEventListener('click', () => {
        document.getElementById('room-password').value = generatePassword();
    });

    createBtn.addEventListener('click', async () => {
        let name = roomInput.value.trim();
        if (!name) name = 'Consult-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        else name = name.replace(/[^a-zA-Z0-9\-_]/g, '-');

        // Auto-generate password if blank
        const pwdInput = document.getElementById('room-password');
        if (!pwdInput.value.trim()) pwdInput.value = generatePassword();
        const password = pwdInput.value.trim();

        try {
            const res = await apiFetch('/api/meetings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ roomName: name, password })
            });
            if (!res.ok) throw new Error('Could not save meeting');
            loadMeetings(); loadOverview();
        } catch (err) { if (err.message !== 'session_expired') showToast(err.message); return; }

        const directLink = window.location.origin + '/host/' + encodeURIComponent(name);
        const pLink      = window.location.origin + '/consent?room=' + encodeURIComponent(name);
        patientLink.textContent = pLink;
        document.getElementById('result-password').textContent = password;
        hostLink.textContent    = directLink;
        resultArea.style.display = 'block';
        joinBtn.onclick = () => window.open(directLink, '_blank');
    });

    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(patientLink.textContent).then(() => showToast('Patient link copied!'));
    });

    document.getElementById('copy-pwd-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('result-password').textContent).then(() => showToast('Password copied!'));
    });

    copyHostBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(hostLink.textContent).then(() => showToast('Host link copied!'));
    });

    /* â”€â”€â”€ Data loaders â”€â”€â”€ */
    async function loadOverview() {
        try {
            const [mRes, cRes] = await Promise.all([apiFetch('/api/meetings'), apiFetch('/api/consents')]);
            const meetings = await mRes.json();
            const consents = await cRes.json();
            document.getElementById('stat-meetings').textContent = meetings.length;
            document.getElementById('stat-consents').textContent = consents.length;
            const today = new Date().toDateString();
            document.getElementById('stat-today').textContent = meetings.filter(m => new Date(m.created_at).toDateString() === today).length;
            const list = document.getElementById('overview-meetings-list');
            if (!meetings.length) { list.innerHTML = '<div class="muted">No meetings yet.</div>'; return; }
            list.innerHTML = meetings.slice(0,6).map(m => {
                const expiry = m.expires_at ? new Date(m.expires_at) : null;
                const isExpired = expiry && expiry < new Date();
                const expiryBadge = isExpired ? ' <span style="font-size:10px;background:rgba(239,68,68,.12);color:var(--red);border-radius:4px;padding:1px 5px;font-weight:600;">EXPIRED</span>' : '';
                const dur = m.duration_seconds != null ? `<span style="font-size:11px;color:var(--teal);margin-left:6px;"><i class="fas fa-clock"></i> ${fmtDuration(m.duration_seconds)}</span>` : '';
                return `
                <div class="data-item">
                    <div><div class="item-title">${m.room_name}${expiryBadge}${dur}</div><div class="item-meta">${new Date(m.created_at).toLocaleString()}</div></div>
                    <a href="/host/${encodeURIComponent(m.room_name)}" target="_blank" class="join-host-btn" title="Join as Host"><i class="fas fa-arrow-right-to-bracket"></i> Join</a>
                </div>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    async function loadMeetings() {
        try {
            const meetings = await (await apiFetch('/api/meetings')).json();
            const list = document.getElementById('meetings-list');
            if (!meetings.length) { list.innerHTML = '<div class="muted">No meetings yet.</div>'; return; }
            list.innerHTML = meetings.map((m, i) => {
                const expiry = m.expires_at ? new Date(m.expires_at) : null;
                const isExpired = expiry && expiry < new Date();
                const expiryStr = expiry
                    ? (isExpired ? '<span style="color:var(--red)">Expired</span>' : 'Expires ' + expiry.toLocaleString())
                    : '';
                const durStr = m.duration_seconds != null
                    ? `<span style="color:var(--teal);"><i class="fas fa-clock"></i> ${fmtDuration(m.duration_seconds)}</span>`
                    : (m.started_at ? '<span style="color:var(--text-2);font-size:11px;">In progress</span>' : '');
                const summaryId   = `summary-${i}`;
                const transcriptId = `transcript-${i}`;
                const notesId      = `notes-${i}`;
                const summaryBlock = m.summary ? `
                    <div class="meeting-summary-toggle" onclick="toggleSummary('${summaryId}')">
                        <i class="fas fa-robot" style="color:var(--teal);"></i> AI Summary
                        <i class="fas fa-chevron-down summary-chevron" id="chev-${summaryId}"></i>
                    </div>
                    <div class="meeting-summary-body" id="${summaryId}" style="display:none;">${m.summary.replace(/\n/g,'<br>')}</div>` : '';
                const transcriptBlock = `
                    <div class="meeting-summary-toggle" onclick="loadTranscript('${m.room_name}','${transcriptId}')">
                        <i class="fas fa-comments" style="color:#94a3b8;"></i> View Transcript
                        <i class="fas fa-chevron-down summary-chevron" id="chev-${transcriptId}"></i>
                    </div>
                    <div class="meeting-summary-body" id="${transcriptId}" style="display:none;padding:0;background:none;border:none;"></div>`;
                const notesBlock = m.soap_notes ? `
                    <div class="meeting-summary-toggle" onclick="toggleSummary('${notesId}')">
                        <i class="fas fa-notes-medical" style="color:#a78bfa;"></i> SOAP Notes
                        <i class="fas fa-chevron-down summary-chevron" id="chev-${notesId}"></i>
                    </div>
                    <div class="meeting-summary-body" id="${notesId}" style="display:none;">${renderSoapNotes(m.soap_notes)}</div>` : '';
                return `
                <div class="data-item meeting-item-card">
                    <div style="width:100%;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
                            <div>
                                <div class="item-title">${m.room_name}</div>
                                <div class="item-meta">${new Date(m.created_at).toLocaleString()}${expiryStr ? ' &nbsp;·&nbsp; ' + expiryStr : ''}${durStr ? ' &nbsp;·&nbsp; ' + durStr : ''}</div>
                            </div>
                            <div style="display:flex;gap:8px;flex-shrink:0;">
                                <button class="join-host-btn" onclick="openInviteModal('${m.room_name}', '${m.password || ''}')" title="Generate patient consent link"><i class="fas fa-user-plus"></i></button>
                                <button class="join-host-btn" onclick="copyRoomLink('${m.room_name}', '${m.password || ''}')" title="Copy patient link"><i class="fas fa-copy"></i></button>
                                <a href="/host/${encodeURIComponent(m.room_name)}" target="_blank" class="join-host-btn primary" title="Join as Host"><i class="fas fa-arrow-right-to-bracket"></i> Join as Host</a>
                            </div>
                        </div>
                        ${summaryBlock}
                        ${transcriptBlock}
                        ${notesBlock}
                    </div>
                </div>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    function toggleSummary(id) {
        const el = document.getElementById(id);
        const chev = document.getElementById('chev-' + id);
        if (!el) return;
        const open = el.style.display === 'none';
        el.style.display = open ? 'block' : 'none';
        if (chev) chev.style.transform = open ? 'rotate(180deg)' : '';
    }

    function renderSoapNotes(raw) {
        if (!raw) return '<em style="color:var(--text-2);">No notes recorded.</em>';
        try {
            const n = JSON.parse(raw);
            const sections = [
                { letter: 'S', label: 'Subjective', value: n.s },
                { letter: 'O', label: 'Objective',  value: n.o },
                { letter: 'A', label: 'Assessment', value: n.a },
                { letter: 'P', label: 'Plan',       value: n.p },
            ].filter(x => x.value && x.value.trim());
            if (!sections.length) return '<em style="color:var(--text-2);">No notes recorded.</em>';
            return sections.map(x => `
                <div style="margin-bottom:10px;">
                    <div style="font-size:11px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">[${x.letter}] ${x.label}</div>
                    <div style="font-size:13px;color:var(--text-1);line-height:1.6;white-space:pre-wrap;">${x.value.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                </div>`).join('');
        } catch(e) {
            return `<pre style="font-size:12px;white-space:pre-wrap;color:var(--text-2);">${raw}</pre>`;
        }
    }

    async function loadTranscript(roomName, containerId) {
        const el = document.getElementById(containerId);
        const chev = document.getElementById('chev-' + containerId);
        if (!el) return;
        const isOpen = el.style.display !== 'none';
        if (isOpen) {
            el.style.display = 'none';
            if (chev) chev.style.transform = '';
            return;
        }
        el.style.display = 'block';
        if (chev) chev.style.transform = 'rotate(180deg)';
        if (el.dataset.loaded) return; // already fetched
        el.innerHTML = '<div style="padding:10px;color:var(--text-2);font-size:0.82rem;">Loading...</div>';
        try {
            const msgs = await (await apiFetch(`/api/meetings/${encodeURIComponent(roomName)}/messages`)).json();
            if (!msgs.length) {
                el.innerHTML = '<div style="padding:10px;color:var(--text-2);font-size:0.82rem;">No chat messages recorded for this meeting.</div>';
            } else {
                el.innerHTML = `<div class="transcript-log">${msgs.map(m => {
                    const t = new Date(m.sent_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    return `<div class="transcript-msg"><span class="transcript-sender">${m.sender_name}</span><span class="transcript-time">${t}</span><div class="transcript-text">${m.message}</div></div>`;
                }).join('')}</div>`;
            }
            el.dataset.loaded = '1';
        } catch(e) {
            el.innerHTML = '<div style="padding:10px;color:var(--red);font-size:0.82rem;">Failed to load transcript.</div>';
        }
    }

    async function loadConsents() {
        try {
            const consents = await (await apiFetch('/api/consents')).json();
            const list = document.getElementById('consents-list');
            if (!consents.length) { list.innerHTML = '<div class="muted">No consent submissions yet.</div>'; return; }
            list.innerHTML = consents.map(c => `
                <div class="data-item">
                    <div>
                        <div class="item-title">${c.first_name} ${c.last_name}</div>
                        <div class="item-meta">Signed ${c.signed_date}</div>
                    </div>
                    <img src="${c.signature}" alt="Signature" class="signature-thumb" />
                </div>`).join('');
        } catch(e) { console.error(e); }
    }

    function showDashboard() {
        loginShell.style.display = 'none';
        adminShell.classList.add('active');
        loadOverview(); loadMeetings(); loadConsents(); loadSettings(); loadUsers();
    }

    async function checkAuth() {
        try {
            const res = await fetch('/api/admin/me');
            if (res.ok) { showDashboard(); return; }
        } catch(e) {}
        loginShell.style.display = 'flex';
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'show';
        t.style.background = type === 'error' ? 'rgba(239,68,68,.96)' : '';
        setTimeout(() => { t.className = t.className.replace('show',''); t.style.background = ''; }, 3500);
    }

    function copyConsentLink() {
        navigator.clipboard.writeText(window.location.origin + '/consent').then(() => showToast('Consent link copied!'));
    }

    /* ─── Users ─── */
    let usersCache = [];
    const AVATAR_COLORS = ['#0d9488','#2563eb','#7c3aed','#db2777','#ea580c','#16a34a'];
    function _avatarColor(name) {
        let h = 0;
        for (const c of name) h = (h * 31 + c.charCodeAt(0)) & 0xffffffff;
        return AVATAR_COLORS[Math.abs(h) % AVATAR_COLORS.length];
    }
    function _initials(name) {
        return name.split(' ').filter(Boolean).map(w => w[0]).slice(0,2).join('').toUpperCase();
    }

    async function loadUsers() {
        try {
            const users = await (await apiFetch('/api/users')).json();
            usersCache = users;
            const el = document.getElementById('stat-users');
            if (el) el.textContent = users.length;
            renderUserCards(users);
        } catch(e) { console.error('loadUsers:', e); }
    }

    function renderUserCards(users) {
        const grid = document.getElementById('users-grid');
        if (!grid) return;
        if (!users.length) {
            grid.innerHTML = '<div class="muted" style="padding:24px 4px;">No users yet. Click <strong>Add User</strong> to create the first provider profile.</div>';
            return;
        }
        grid.innerHTML = users.map(u => {
            const initials = _initials(u.name);
            const color    = _avatarColor(u.name);
            const avatar   = u.photo_url
                ? `<img src="${u.photo_url}" alt="${u.name}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;flex-shrink:0;" onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'${initials}',style:'width:56px;height:56px;border-radius:50%;background:${color};color:#fff;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;'}))" />`
                : `<div style="width:56px;height:56px;border-radius:50%;background:${color};color:#fff;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;">${initials}</div>`;
            return `
            <div class="user-card">
                <div style="display:flex;align-items:flex-start;gap:14px;">
                    ${avatar}
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;font-size:1rem;">${u.name}</div>
                        <div style="margin-top:4px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                            <span style="background:rgba(13,148,136,.13);color:var(--teal);padding:2px 9px;border-radius:20px;font-size:11px;font-weight:600;">${u.role}</span>
                            ${u.specialty ? `<span style="font-size:11px;color:var(--text-3);">${u.specialty}</span>` : ''}
                            ${u.username  ? `<span style="font-size:11px;color:var(--text-3);font-family:monospace;">@${u.username}</span>` : ''}
                        </div>
                        ${u.bio ? `<div style="font-size:12px;color:var(--text-2);margin-top:7px;line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${u.bio}</div>` : ''}
                        <div style="display:flex;gap:14px;margin-top:8px;flex-wrap:wrap;">
                            ${u.email ? `<span style="font-size:11px;color:var(--text-3);"><i class="fas fa-envelope" style="margin-right:4px;"></i>${u.email}</span>` : ''}
                            ${u.phone ? `<span style="font-size:11px;color:var(--text-3);"><i class="fas fa-phone" style="margin-right:4px;"></i>${u.phone}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);align-items:center;">
                    <a href="/profile/${u.id}" target="_blank" class="secondary-btn" style="padding:6px 12px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);font-size:12px;text-decoration:none;display:inline-flex;align-items:center;gap:5px;">
                        <i class="fas fa-id-card"></i> Profile
                    </a>
                    <button onclick="openUserModal(${u.id})" class="secondary-btn" style="padding:6px 12px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);font-size:12px;display:inline-flex;align-items:center;gap:5px;">
                        <i class="fas fa-pencil"></i> Edit
                    </button>
                    <button onclick="deleteUser(${u.id})" class="secondary-btn" style="padding:6px 12px;border-radius:var(--r-md);border:1px solid rgba(239,68,68,.3);background:var(--bg);color:#ef4444;font-size:12px;display:inline-flex;align-items:center;gap:5px;margin-left:auto;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    function openUserModal(idOrUndefined) {
        const u = (idOrUndefined != null) ? usersCache.find(x => x.id === idOrUndefined) : null;
        const isEdit = !!u;
        document.getElementById('user-modal-title').textContent      = isEdit ? 'Edit User' : 'Add User';
        document.getElementById('user-modal-save-label').textContent = isEdit ? 'Save Changes' : 'Save User';
        document.getElementById('user-modal-id').value       = u ? u.id          : '';
        document.getElementById('um-name').value             = u ? u.name        : '';
        document.getElementById('um-role').value             = u ? u.role        : 'Doctor';
        document.getElementById('um-specialty').value        = u ? (u.specialty  || '') : '';
        document.getElementById('um-email').value            = u ? (u.email      || '') : '';
        document.getElementById('um-phone').value            = u ? (u.phone      || '') : '';
        document.getElementById('um-bio').value              = u ? (u.bio        || '') : '';
        document.getElementById('um-photo').value            = u ? (u.photo_url  || '') : '';
        document.getElementById('um-username').value         = u ? (u.username   || '') : '';
        document.getElementById('um-password').value         = '';
        document.getElementById('um-password-confirm').value = '';
        // Password label: required on add, optional on edit
        document.getElementById('um-pwd-label').innerHTML = isEdit
            ? 'New Password <span style="color:var(--text-3);font-weight:400;">(leave blank to keep)</span>'
            : 'Password <span style="color:#ef4444;">*</span>';
        document.getElementById('user-modal-error').textContent = '';
        document.getElementById('user-modal').style.display = 'flex';
        setTimeout(() => document.getElementById('um-name').focus(), 80);
    }

    function closeUserModal() {
        document.getElementById('user-modal').style.display = 'none';
    }

    async function saveUser() {
        const id       = document.getElementById('user-modal-id').value;
        const name     = document.getElementById('um-name').value.trim();
        const username = document.getElementById('um-username').value.trim().toLowerCase();
        const password = document.getElementById('um-password').value;
        const confirm  = document.getElementById('um-password-confirm').value;
        const errEl    = document.getElementById('user-modal-error');
        if (!name)     { errEl.textContent = 'Full name is required.'; return; }
        if (!username) { errEl.textContent = 'Username is required.'; return; }
        if (!id && !password) { errEl.textContent = 'Password is required for new users.'; return; }
        if (password && password !== confirm) { errEl.textContent = 'Passwords do not match.'; return; }
        if (password && password.length < 6)  { errEl.textContent = 'Password must be at least 6 characters.'; return; }
        errEl.textContent = '';
        const payload = {
            name, username,
            role:      document.getElementById('um-role').value,
            specialty: document.getElementById('um-specialty').value.trim(),
            email:     document.getElementById('um-email').value.trim(),
            phone:     document.getElementById('um-phone').value.trim(),
            bio:       document.getElementById('um-bio').value.trim(),
            photo_url: document.getElementById('um-photo').value.trim()
        };
        if (password) payload.password = password;
        try {
            const url  = id ? `/api/users/${id}` : '/api/users';
            const meth = id ? 'PUT' : 'POST';
            const res  = await apiFetch(url, { method: meth, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.ok) { const e = await res.json(); errEl.textContent = e.error || 'Save failed'; return; }
            closeUserModal();
            loadUsers();
            showToast(id ? 'User updated!' : 'User added!');
        } catch(e) { if (e.message !== 'session_expired') errEl.textContent = 'Network error.'; }
    }

    async function deleteUser(id) {
        const u = usersCache.find(x => x.id === id);
        if (!u || !confirm(`Delete "${u.name}"? This cannot be undone.`)) return;
        try {
            const res = await apiFetch(`/api/users/${id}`, { method: 'DELETE' });
            if (!res.ok) { showToast('Delete failed'); return; }
            loadUsers();
            showToast('User deleted.');
        } catch(e) { if (e.message !== 'session_expired') showToast('Delete failed.'); }
    }

    function fmtDuration(sec) {
        if (sec == null || sec < 0) return '';
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function copyRoomLink(roomName, password) {
        const base = window.location.origin + '/consent?room=' + encodeURIComponent(roomName);
        const link = password ? base + '&pwd=' + encodeURIComponent(password) : base;
        navigator.clipboard.writeText(link).then(() => showToast('Patient link copied!'));
    }

    /* ─── Settings ─── */
    async function loadSettings() {
        try {
            const res = await fetch('/api/settings');
            if (!res.ok) return;
            const s = await res.json();
            if (s.company_name) {
                document.getElementById('cfg-company').value = s.company_name;
                document.querySelectorAll('.dynamic-company-name').forEach(el => el.textContent = s.company_name);
                document.title = s.company_name + ' — Admin';
            }
            if (s.tagline)       document.getElementById('cfg-tagline').value = s.tagline;
            if (s.timezone)      document.getElementById('cfg-timezone').value = s.timezone;
            if (s.contact_email) document.getElementById('cfg-email').value = s.contact_email;
            if (s.contact_phone) document.getElementById('cfg-phone').value = s.contact_phone;
            if (s.company_logo) {
                document.getElementById('cfg-logo').value = s.company_logo;
                applyLogo(s.company_logo);
            }
            if (s.smtp_host)    document.getElementById('cfg-smtp-host').value    = s.smtp_host;
            if (s.smtp_port)    document.getElementById('cfg-smtp-port').value    = s.smtp_port;
            if (s.smtp_user)    document.getElementById('cfg-smtp-user').value    = s.smtp_user;
            if (s.smtp_pass)    document.getElementById('cfg-smtp-pass').value    = s.smtp_pass;
            if (s.smtp_from)    document.getElementById('cfg-smtp-from').value    = s.smtp_from;
            if (s.twilio_sid)   document.getElementById('cfg-twilio-sid').value   = s.twilio_sid;
            if (s.twilio_token) document.getElementById('cfg-twilio-token').value = s.twilio_token;
            if (s.twilio_from)  document.getElementById('cfg-twilio-from').value  = s.twilio_from;
        } catch(e) { console.error('loadSettings:', e); }
    }

    function applyLogo(url) {
        // Sidebar icon
        const iconEl = document.getElementById('sidebar-logo-icon');
        if (iconEl) {
            if (url) {
                iconEl.innerHTML = `<img src="${url}" alt="logo" style="width:36px;height:36px;object-fit:contain;border-radius:6px;" onerror="this.parentElement.innerHTML='<i class=\'fas fa-heartbeat\'></i>'">`;
            } else {
                iconEl.innerHTML = '<i class="fas fa-heartbeat"></i>';
            }
        }
        // Favicon dynamic
        const fav = document.getElementById('dynamic-favicon');
        if (fav) fav.href = url || 'data:,';
        // Logo preview box
        const preview = document.getElementById('cfg-logo-preview');
        const img     = document.getElementById('cfg-logo-img');
        if (preview && img) {
            if (url) { img.src = url; preview.style.display = ''; }
            else { preview.style.display = 'none'; }
        }
    }

    // Live preview as user types logo URL
    document.getElementById('cfg-logo').addEventListener('input', function() {
        applyLogo(this.value.trim());
    });

    document.getElementById('save-settings-btn').addEventListener('click', async () => {
        const hint = document.getElementById('settings-hint');
        try {
            const res = await apiFetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_name: document.getElementById('cfg-company').value.trim(),
                    tagline:      document.getElementById('cfg-tagline').value.trim(),
                    timezone:     document.getElementById('cfg-timezone').value,
                    contact_email:document.getElementById('cfg-email').value.trim(),
                    contact_phone:document.getElementById('cfg-phone').value.trim(),
                    company_logo: document.getElementById('cfg-logo').value.trim(),
                    smtp_host:     document.getElementById('cfg-smtp-host').value.trim(),
                    smtp_port:     document.getElementById('cfg-smtp-port').value.trim(),
                    smtp_user:     document.getElementById('cfg-smtp-user').value.trim(),
                    smtp_pass:     document.getElementById('cfg-smtp-pass').value.trim(),
                    smtp_from:     document.getElementById('cfg-smtp-from').value.trim(),
                    twilio_sid:    document.getElementById('cfg-twilio-sid').value.trim(),
                    twilio_token:  document.getElementById('cfg-twilio-token').value.trim(),
                    twilio_from:   document.getElementById('cfg-twilio-from').value.trim()
                })
            });
            if (!res.ok) throw new Error('Save failed');
            showToast('Settings saved successfully!');
            hint.textContent = 'Saved ✓';
            hint.style.color = 'var(--green)';
            const name = document.getElementById('cfg-company').value.trim();
            if (name) {
                document.querySelectorAll('.dynamic-company-name').forEach(el => el.textContent = name);
                document.title = name + ' — Admin';
            }
            const logo = document.getElementById('cfg-logo').value.trim();
            applyLogo(logo);
            setTimeout(() => { hint.textContent = ''; }, 3000);
        } catch(e) {
            showToast('Could not save settings');
            hint.textContent = e.message;
            hint.style.color = 'var(--red)';
        }
    });

    checkAuth();

    /* ─── Change Password ─── */
    document.getElementById('sec-save-btn').addEventListener('click', async () => {
        const current  = document.getElementById('sec-current-pwd').value;
        const newPwd   = document.getElementById('sec-new-pwd').value;
        const confirm  = document.getElementById('sec-confirm-pwd').value;
        const errEl    = document.getElementById('sec-error');
        errEl.textContent = '';

        if (!current || !newPwd || !confirm) { errEl.textContent = 'All three fields are required.'; return; }
        if (newPwd.length < 8)               { errEl.textContent = 'New password must be at least 8 characters.'; return; }
        if (newPwd !== confirm)              { errEl.textContent = 'New passwords do not match.'; return; }

        const btn = document.getElementById('sec-save-btn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving…';
        try {
            const r = await fetch('/api/admin/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword: current, newPassword: newPwd })
            });
            const data = await r.json();
            if (!r.ok) throw new Error(data.error || 'Failed');
            document.getElementById('sec-current-pwd').value = '';
            document.getElementById('sec-new-pwd').value = '';
            document.getElementById('sec-confirm-pwd').value = '';
            showToast('Password updated successfully!');
        } catch(e) {
            errEl.textContent = e.message;
        } finally {
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-floppy-disk"></i> Update Password';
        }
    });

    /* ─── Invite Patient modal JS ─── */
    let _inviteRoom = '';

    /* ─── Analytics ─── */
    function fmtSec(s) {
        if (!s) return '—';
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
        return h > 0 ? `${h}h ${m}m` : m > 0 ? `${m}m ${sec}s` : `${sec}s`;
    }

    // ── Analytics date range helpers ──────────────────────────────────────────
    function fmtDateLocal(d) {
        const pad = n => String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function setAnalyticsPreset(btn) {
        document.querySelectorAll('.an-preset').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const today = new Date();
        const toStr = fmtDateLocal(today);
        const preset = btn.dataset.preset;
        let fromStr = '';
        if (preset === 'all') {
            document.getElementById('an-from').value = '';
            document.getElementById('an-to').value   = '';
        } else {
            const days = preset === '7d' ? 7 : preset === '30d' ? 30 : preset === '90d' ? 90 : 365;
            const from = new Date(today); from.setDate(from.getDate() - days + 1);
            fromStr = fmtDateLocal(from);
            document.getElementById('an-from').value = fromStr;
            document.getElementById('an-to').value   = toStr;
        }
        loadAnalytics();
    }

    function onAnalyticsDateChange() {
        document.querySelectorAll('.an-preset').forEach(b => b.classList.remove('active'));
        loadAnalytics();
    }

    async function loadAnalytics() {
        const from = document.getElementById('an-from')?.value || '';
        const to   = document.getElementById('an-to')?.value   || '';
        let qs = '';
        if (from || to) {
            qs = '?' + new URLSearchParams(Object.fromEntries(Object.entries({from,to}).filter(([,v])=>v))).toString();
        }
        // Update range label
        const label = document.getElementById('an-range-label');
        if (label) label.textContent = from && to ? `${from} → ${to}` : from ? `From ${from}` : to ? `To ${to}` : 'All time';
        try {
            const data = await (await apiFetch('/api/analytics' + qs)).json();

            // KPIs
            document.getElementById('an-total').textContent    = data.totalMeetings?.count ?? '—';
            document.getElementById('an-avgdur').textContent   = fmtSec(+data.avgDuration?.avg) || '—';
            const total   = data.totalMeetings?.count || 0;
            const complet = data.completedMeetings?.count || 0;
            document.getElementById('an-complete').textContent = total ? Math.round(complet/total*100) + '%' : '—';
            const retPct = (data.totalPatients?.count > 0)
                ? Math.round((data.returningPatients?.count || 0) / data.totalPatients.count * 100) + '%'
                : '—';
            document.getElementById('an-returning').textContent = retPct;

            // Chart colours
            const C_TEAL   = '#14b8a6';
            const C_PURPLE = '#a78bfa';
            const C_AMBER  = '#f59e0b';
            const C_GREEN  = '#22c55e';
            const C_BG     = '#1e293b';
            const C_FG     = '#94a3b8';

            // ─── Helper: draw a vertical bar chart ───────────────────────────────
            function barChart(canvasId, emptyId, labels, values, color) {
                const canvas = document.getElementById(canvasId);
                const empty  = document.getElementById(emptyId);
                if (!canvas) return;
                const maxVal = Math.max(...values, 1);
                const W = canvas.offsetWidth || 600;
                const H = canvas.offsetHeight || 200;
                canvas.width  = W * devicePixelRatio;
                canvas.height = H * devicePixelRatio;
                const ctx = canvas.getContext('2d');
                ctx.scale(devicePixelRatio, devicePixelRatio);

                if (!values.some(v => v > 0)) { canvas.style.display='none'; if(empty) empty.style.display='flex'; return; }
                canvas.style.display='block'; if(empty) empty.style.display='none';

                const PAD = { top: 20, right: 10, bottom: 36, left: 36 };
                const cW = W - PAD.left - PAD.right;
                const cH = H - PAD.top  - PAD.bottom;
                const barW = Math.max(4, Math.floor(cW / labels.length) - 4);

                // Y gridlines
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.lineWidth = 1;
                [0.25,0.5,0.75,1].forEach(f => {
                    const y = PAD.top + cH * (1 - f);
                    ctx.beginPath(); ctx.moveTo(PAD.left, y); ctx.lineTo(W - PAD.right, y); ctx.stroke();
                    ctx.fillStyle = C_FG; ctx.font = `10px Inter,sans-serif`; ctx.textAlign = 'right';
                    ctx.fillText(Math.round(maxVal * f), PAD.left - 4, y + 3);
                });

                // Bars
                labels.forEach((lbl, i) => {
                    const x  = PAD.left + i * (cW / labels.length) + (cW/labels.length - barW) / 2;
                    const bh = Math.max(2, (values[i] / maxVal) * cH);
                    const y  = PAD.top + cH - bh;

                    const grad = ctx.createLinearGradient(0, y, 0, y + bh);
                    grad.addColorStop(0, color);
                    grad.addColorStop(1, color + '55');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    const r = Math.min(4, barW/2);
                    ctx.roundRect(x, y, barW, bh, [r, r, 0, 0]);
                    ctx.fill();

                    // Value label above bar
                    if (values[i] > 0) {
                        ctx.fillStyle = color; ctx.font = `bold 10px Inter,sans-serif`; ctx.textAlign = 'center';
                        ctx.fillText(values[i], x + barW / 2, y - 4);
                    }

                    // X label
                    ctx.fillStyle = C_FG; ctx.font = `10px Inter,sans-serif`; ctx.textAlign = 'center';
                    ctx.fillText(lbl, x + barW / 2, H - PAD.bottom + 16);
                });
            }

            // ─── Helper: area/line chart ─────────────────────────────────────────
            function areaChart(canvasId, emptyId, labels, values, color) {
                const canvas = document.getElementById(canvasId);
                const empty  = document.getElementById(emptyId);
                if (!canvas) return;
                const maxVal = Math.max(...values, 1);
                const W = canvas.offsetWidth || 600;
                const H = canvas.offsetHeight || 160;
                canvas.width  = W * devicePixelRatio;
                canvas.height = H * devicePixelRatio;
                const ctx = canvas.getContext('2d');
                ctx.scale(devicePixelRatio, devicePixelRatio);

                if (!values.some(v => v > 0)) { canvas.style.display='none'; if(empty) empty.style.display='flex'; return; }
                canvas.style.display='block'; if(empty) empty.style.display='none';

                const PAD = { top: 16, right: 10, bottom: 28, left: 36 };
                const cW = W - PAD.left - PAD.right;
                const cH = H - PAD.top  - PAD.bottom;

                const points = values.map((v, i) => ({
                    x: PAD.left + (i / Math.max(labels.length - 1, 1)) * cW,
                    y: PAD.top  + cH * (1 - v / maxVal)
                }));

                // Fill area
                const grad = ctx.createLinearGradient(0, PAD.top, 0, PAD.top + cH);
                grad.addColorStop(0, color + '44');
                grad.addColorStop(1, color + '00');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.moveTo(points[0].x, PAD.top + cH);
                points.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.lineTo(points[points.length-1].x, PAD.top + cH);
                ctx.closePath(); ctx.fill();

                // Line
                ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.lineJoin = 'round';
                ctx.beginPath();
                points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
                ctx.stroke();

                // Dots
                points.forEach(p => {
                    ctx.fillStyle = color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                });

                // X labels (show every Nth)
                const step = Math.max(1, Math.floor(labels.length / 8));
                ctx.fillStyle = C_FG; ctx.font = `10px Inter,sans-serif`; ctx.textAlign = 'center';
                labels.forEach((l, i) => {
                    if (i % step === 0 || i === labels.length - 1)
                        ctx.fillText(l, points[i].x, H - PAD.bottom + 14);
                });
            }

            // ─── Calls per week ───────────────────────────────────────────────────
            (() => {
                const weeks = data.perWeek || [];
                // Build 8-week scaffold
                const scaffold = [];
                for (let i = 7; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i * 7);
                    const yr  = d.getFullYear();
                    const wk  = String(getISOWeek(d)).padStart(2,'0');
                    scaffold.push({ key: `${yr}-${wk}`, label: `W${wk}` });
                }
                const map = Object.fromEntries(weeks.map(r => [r.week, r.count]));
                barChart('chart-weekly','chart-weekly-empty', scaffold.map(s=>s.label), scaffold.map(s=>map[s.key]||0), C_TEAL);
            })();

            // ─── Duration buckets ─────────────────────────────────────────────────
            (() => {
                const ORDER = ['< 2 min','2-5 min','5-10 min','10-30 min','30+ min'];
                const map   = Object.fromEntries((data.durationBuckets||[]).map(r=>[r.bucket,r.count]));
                barChart('chart-duration','chart-duration-empty', ORDER, ORDER.map(k=>map[k]||0), C_PURPLE);
            })();

            // ─── Busiest hours ────────────────────────────────────────────────────
            (() => {
                const labels = Array.from({length:24}, (_,i) => i % 6===0 ? `${i}:00` : '');
                const map    = Object.fromEntries((data.perHour||[]).map(r=>[r.hour,r.count]));
                barChart('chart-hours','chart-hours-empty', labels, Array.from({length:24},(_,i)=>map[i]||0), C_AMBER);
            })();

            // ─── Daily volume ─────────────────────────────────────────────────────
            (() => {
                const rows   = data.perDay || [];
                if (!rows.length) { document.getElementById('chart-daily').style.display='none'; document.getElementById('chart-daily-empty').style.display='flex'; return; }
                const labels = rows.map(r => r.day.slice(5));   // MM-DD
                const values = rows.map(r => r.count);
                areaChart('chart-daily','chart-daily-empty', labels, values, C_GREEN);
            })();

        } catch(e) { console.error('analytics:', e); }
    }

    function getISOWeek(d) {
        const date = new Date(d);
        date.setHours(0,0,0,0);
        date.setDate(date.getDate() + 4 - (date.getDay() || 7));
        const y = new Date(date.getFullYear(), 0, 1);
        return Math.ceil((((date - y) / 86400000) + 1) / 7);
    }

    window.openInviteModal = function(roomName) {
        _inviteRoom = roomName;
        document.getElementById('invite-name').value  = '';
        document.getElementById('invite-email').value = '';
        updateInviteLink();
        document.getElementById('invite-patient-modal').style.display = 'flex';
    };

    window.closeInviteModal = function() {
        document.getElementById('invite-patient-modal').style.display = 'none';
    };

    function updateInviteLink() {
        const base  = window.location.origin + '/consent?room=' + encodeURIComponent(_inviteRoom);
        const name  = document.getElementById('invite-name').value.trim();
        const email = document.getElementById('invite-email').value.trim();
        let url = base;
        if (name)  url += '&name='  + encodeURIComponent(name);
        if (email) url += '&email=' + encodeURIComponent(email);
        document.getElementById('invite-link-output').value = url;
    }

    window.copyInviteLink = function() {
        updateInviteLink();
        navigator.clipboard.writeText(document.getElementById('invite-link-output').value)
            .then(() => showToast('Link copied!'));
    };

    window.sendInvite = async function(method) {
        updateInviteLink();
        const name  = document.getElementById('invite-name').value.trim();
        const email = document.getElementById('invite-email').value.trim();
        const phone = document.getElementById('invite-phone').value.trim();
        const link  = document.getElementById('invite-link-output').value;

        if (method === 'email' && !email) { showToast('Enter a patient email address first.', 'error'); return; }
        if (method === 'sms'   && !phone) { showToast('Enter a patient phone number first.', 'error'); return; }

        const to = method === 'email' ? email : phone;
        try {
            const r = await fetch('/api/invite/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (localStorage.getItem('adminToken') || '') },
                body: JSON.stringify({ method, to, patientName: name, link, roomName: _inviteRoom })
            });
            const data = await r.json();
            if (!r.ok) throw new Error(data.error || 'Failed');
            showToast(method === 'email' ? `Email sent to ${email}` : `SMS sent to ${phone}`);
            closeInviteModal();
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    };

    document.getElementById('invite-name').addEventListener('input', updateInviteLink);
    document.getElementById('invite-email').addEventListener('input', updateInviteLink);
</script>

<!-- Invite Patient Modal -->
<div id="invite-patient-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:3000;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-xl);padding:28px;width:100%;max-width:450px;box-shadow:0 24px 60px rgba(0,0,0,.6);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 style="margin:0;font-size:1.05rem;"><i class="fas fa-user-plus" style="color:var(--teal);margin-right:8px;"></i>Send Consent Form to Patient</h3>
            <button onclick="closeInviteModal()" style="background:none;border:none;color:var(--text-2);cursor:pointer;font-size:1.2rem;padding:4px;"><i class="fas fa-times"></i></button>
        </div>
        <p style="font-size:13px;color:var(--text-2);margin:0 0 20px;">Fill in the patient's details, then send the pre-filled consent form link via email, SMS, or copy it manually.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div class="form-group" style="margin:0;">
                <label>Patient Name <span style="color:var(--text-3);font-weight:400;">(optional)</span></label>
                <input type="text" id="invite-name" placeholder="e.g. Jane Doe" />
            </div>
            <div class="form-group" style="margin:0;">
                <label>Patient Email</label>
                <input type="email" id="invite-email" placeholder="jane@example.com" />
            </div>
        </div>
        <div class="form-group" style="margin-bottom:14px;">
            <label>Patient Phone <span style="color:var(--text-3);font-weight:400;">(for SMS — E.164 format)</span></label>
            <input type="tel" id="invite-phone" placeholder="e.g. +15550001234" />
        </div>
        <div class="form-group" style="margin-bottom:18px;">
            <label>Consultation Link</label>
            <div style="display:flex;gap:8px;">
                <input type="text" id="invite-link-output" readonly style="flex:1;font-size:12px;color:var(--teal);background:rgba(20,184,166,.06);cursor:text;" onclick="this.select();" />
                <button class="join-host-btn" onclick="navigator.clipboard.writeText(document.getElementById('invite-link-output').value).then(()=>showToast('Copied!'))" title="Copy link"><i class="fas fa-copy"></i></button>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <button class="btn-primary" style="justify-content:center;font-size:13px;padding:10px 8px;" onclick="sendInvite('email')">
                <i class="fas fa-envelope"></i> Send Email
            </button>
            <button class="btn-primary" style="justify-content:center;font-size:13px;padding:10px 8px;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text);" onclick="sendInvite('sms')">
                <i class="fas fa-comment-sms"></i> Send SMS
            </button>
            <button class="btn-primary" style="justify-content:center;font-size:13px;padding:10px 8px;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text);" onclick="copyInviteLink()">
                <i class="fas fa-copy"></i> Copy Link
            </button>
        </div>
    </div>
</div>

<script>
/* ═══════════════════════════════════════════════════
   APPOINTMENTS
═══════════════════════════════════════════════════ */
let apptYear  = new Date().getFullYear();
let apptMonth = new Date().getMonth(); // 0-indexed
let allAppts  = [];
let selectedDay = null;

const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

async function loadAppointments() {
    try {
        const r = await fetch(`/api/appointments?year=${apptYear}&month=${apptMonth + 1}`);
        allAppts = await r.json();
        renderCalendar();
        renderApptList(allAppts);
    } catch(e) {
        console.error('loadAppointments', e);
    }
}

function apptMonthShift(delta) {
    apptMonth += delta;
    if (apptMonth < 0) { apptMonth = 11; apptYear--; }
    if (apptMonth > 11) { apptMonth = 0; apptYear++; }
    selectedDay = null;
    loadAppointments();
}

function renderCalendar() {
    document.getElementById('appt-month-label').textContent = `${MONTH_NAMES[apptMonth]} ${apptYear}`;
    const grid = document.getElementById('appt-calendar-grid');
    grid.innerHTML = '';
    const firstDay = new Date(apptYear, apptMonth, 1).getDay();
    const daysInMonth = new Date(apptYear, apptMonth + 1, 0).getDate();
    const today = new Date();
    // Blank cells
    for (let i = 0; i < firstDay; i++) { const b = document.createElement('div'); b.className = 'appt-cal-cell empty'; grid.appendChild(b); }
    for (let d = 1; d <= daysInMonth; d++) {
        const cell = document.createElement('div');
        cell.className = 'appt-cal-cell';
        const isToday = today.getFullYear() === apptYear && today.getMonth() === apptMonth && today.getDate() === d;
        if (isToday) cell.classList.add('today');
        if (selectedDay === d) cell.classList.add('selected');
        const dayAppts = allAppts.filter(a => new Date(a.scheduled_at).getDate() === d);
        cell.innerHTML = `<span class="cal-day-num">${d}</span>${dayAppts.length ? `<span class="cal-dot" title="${dayAppts.length} appt"></span>` : ''}`;
        cell.onclick = () => { selectedDay = d; renderCalendar(); filterApptByDay(d); };
        grid.appendChild(cell);
    }
}

function filterApptByDay(d) {
    const label = document.getElementById('appt-list-label');
    const filtered = allAppts.filter(a => new Date(a.scheduled_at).getDate() === d);
    label.textContent = `${MONTH_NAMES[apptMonth]} ${d}, ${apptYear} — ${filtered.length} appointment${filtered.length !== 1 ? 's' : ''}`;
    renderApptList(filtered);
}

function renderApptList(list) {
    const el = document.getElementById('appt-list');
    if (!list.length) { el.innerHTML = '<div class="appt-empty">No appointments for this period</div>'; return; }
    el.innerHTML = list.map(a => {
        const dt = new Date(a.scheduled_at);
        const timeStr = dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        const dateStr = dt.toLocaleDateString([], {month:'short', day:'numeric'});
        const statusColor = { scheduled:'var(--teal)', cancelled:'var(--red,#ef4444)', completed:'var(--green)', no_show:'#f59e0b' }[a.status] || 'var(--text-2)';
        const hostLink = a.room_name ? `${location.origin}/?room=${encodeURIComponent(a.room_name)}` : null;
        return `<div class="appt-card">
            <div class="appt-card-time"><i class="fas fa-clock"></i> ${dateStr} ${timeStr}</div>
            <div class="appt-card-name">${esc(a.patient_name)}</div>
            <div class="appt-card-meta">${esc(a.patient_email || '')} ${a.patient_phone ? '· '+ esc(a.patient_phone) : ''}</div>
            ${a.notes ? `<div class="appt-card-notes">${esc(a.notes)}</div>` : ''}
            <div class="appt-card-footer">
                <span class="appt-status-badge" style="color:${statusColor};background:${statusColor}22;">${a.status}</span>
                <span style="font-size:12px;color:var(--text-2);">${a.duration_minutes} min</span>
                <div style="display:flex;gap:6px;margin-left:auto;">
                    ${hostLink ? `<a href="${hostLink}" target="_blank" class="secondary-btn" style="padding:4px 10px;border-radius:var(--r-sm);border:1px solid var(--teal);background:rgba(20,184,166,.1);cursor:pointer;font-size:12px;color:var(--teal);text-decoration:none;display:inline-flex;align-items:center;gap:4px;" title="Join as host"><i class="fas fa-video"></i> Join</a>` : ''}
                    ${hostLink ? `<button onclick="showApptLinks('${esc(a.room_name)}')" class="secondary-btn" style="padding:4px 10px;border-radius:var(--r-sm);border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:12px;" title="Copy meeting links"><i class="fas fa-link"></i></button>` : ''}
                    <button onclick="editAppt(${a.id})" class="secondary-btn" style="padding:4px 10px;border-radius:var(--r-sm);border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:12px;"><i class="fas fa-pen"></i></button>
                    <button onclick="deleteAppt(${a.id})" class="secondary-btn" style="padding:4px 10px;border-radius:var(--r-sm);border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:12px;color:var(--red,#ef4444);"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function openApptModal(appt) {
    document.getElementById('appt-modal-id').value = appt ? appt.id : '';
    document.getElementById('appt-modal-title').textContent = appt ? 'Edit Appointment' : 'New Appointment';
    document.getElementById('appt-modal-save-label').textContent = appt ? 'Save Changes' : 'Save Appointment';
    document.getElementById('am-name').value = appt ? appt.patient_name : '';
    document.getElementById('am-email').value = appt ? (appt.patient_email || '') : '';
    document.getElementById('am-phone').value = appt ? (appt.patient_phone || '') : '';
    document.getElementById('am-notes').value = appt ? (appt.notes || '') : '';
    // Duration buttons
    const dur = appt ? String(appt.duration_minutes) : '15';
    document.getElementById('am-duration').value = dur;
    document.querySelectorAll('.appt-dur-btn').forEach(b => b.classList.toggle('active', b.dataset.val === dur));
    // Split date + time
    if (appt && appt.scheduled_at) {
        const d = new Date(appt.scheduled_at);
        const pad = n => String(n).padStart(2,'0');
        document.getElementById('am-date').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        document.getElementById('am-time').value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } else {
        document.getElementById('am-date').value = '';
        document.getElementById('am-time').value = '';
    }
    // Reset invite toggle
    const cb = document.getElementById('am-send-invite');
    cb.checked = !appt;
    updateInviteToggle(cb);
    document.getElementById('appt-modal-error').textContent = '';
    const modal = document.getElementById('appt-modal');
    modal.style.display = 'flex';
}

function closeApptModal() { document.getElementById('appt-modal').style.display = 'none'; }

async function saveAppt() {
    const id = document.getElementById('appt-modal-id').value;
    // Combine split date + time into scheduled_at
    const dateVal = document.getElementById('am-date').value;
    const timeVal = document.getElementById('am-time').value;
    const combinedDt = dateVal && timeVal ? `${dateVal}T${timeVal}` : (dateVal || '');
    const body = {
        patient_name: document.getElementById('am-name').value.trim(),
        patient_email: document.getElementById('am-email').value.trim(),
        patient_phone: document.getElementById('am-phone').value.trim(),
        scheduled_at: combinedDt,
        duration_minutes: parseInt(document.getElementById('am-duration').value) || 30,
        notes: document.getElementById('am-notes').value.trim(),
        send_invite: document.getElementById('am-send-invite').checked,
    };
    if (!body.patient_name) { document.getElementById('appt-modal-error').textContent = 'Patient name is required.'; return; }
    if (!body.scheduled_at)  { document.getElementById('appt-modal-error').textContent = 'Date & time is required.'; return; }
    try {
        const res = await fetch(id ? `/api/appointments/${id}` : '/api/appointments', {
            method: id ? 'PUT' : 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        closeApptModal();
        loadAppointments();
        if (!id && data.room_name) {
            showMeetingLinks(data, body.patient_name, body.patient_email);
        } else {
            showToast(id ? 'Appointment updated' : 'Appointment created');
        }
    } catch(e) {
        document.getElementById('appt-modal-error').textContent = e.message;
    }
}

async function editAppt(id) {
    const appt = allAppts.find(a => a.id === id);
    if (appt) openApptModal(appt);
}

async function deleteAppt(id) {
    if (!confirm('Delete this appointment?')) return;
    try {
        const r = await fetch(`/api/appointments/${id}`, { method:'DELETE' });
        if (!r.ok) throw new Error('Failed');
        showToast('Appointment deleted');
        loadAppointments();
    } catch(e) { showToast(e.message, 'error'); }
}

function selectDuration(btn) {
    document.querySelectorAll('.appt-dur-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('am-duration').value = btn.dataset.val;
}

function updateInviteToggle(cb) {
    const track = document.getElementById('am-invite-track');
    const thumb = document.getElementById('am-invite-thumb');
    if (!track || !thumb) return;
    track.style.background = cb.checked ? 'var(--teal)' : 'rgba(255,255,255,.15)';
    thumb.style.left = cb.checked ? '18px' : '2px';
}

/* ═══════════════════════════════════════════════════
   PATIENTS
═══════════════════════════════════════════════════ */
let allPatients = [];
let currentPtEmail = null;
let currentPtTab = 'overview';

async function loadPatients() {
    try {
        const r = await fetch('/api/patients');
        allPatients = await r.json();
        renderPatientCards(allPatients);
    } catch(e) { console.error('loadPatients', e); }
}

function filterPatients() {
    const q = document.getElementById('pt-search').value.toLowerCase();
    renderPatientCards(q ? allPatients.filter(p => (p.name||'').toLowerCase().includes(q) || (p.email||'').toLowerCase().includes(q)) : allPatients);
}

function renderPatientCards(list) {
    const el = document.getElementById('pt-list');
    if (!list.length) { el.innerHTML = '<div class="appt-empty" style="grid-column:1/-1;">No patients found</div>'; return; }
    el.innerHTML = list.map(p => `<div class="pt-card" onclick="openPtHistory('${esc(p.email)}','${esc(p.name)}')">
        <div class="pt-card-avatar"><i class="fas fa-user-injured"></i></div>
        <div class="pt-card-info">
            <div class="pt-card-name">${esc(p.name || 'Unknown')}</div>
            <div class="pt-card-email">${esc(p.email || '—')}</div>
        </div>
        <div class="pt-card-stats">
            <span title="Visits"><i class="fas fa-video"></i> ${p.visit_count||0}</span>
            <span title="Consents"><i class="fas fa-file-signature"></i> ${p.consent_count||0}</span>
        </div>
        <div class="pt-card-last">${p.last_seen ? new Date(p.last_seen).toLocaleDateString() : '—'}</div>
    </div>`).join('');
}

async function openPtHistory(email, name) {
    currentPtEmail = email;
    document.getElementById('pt-history-name').textContent = name || email;
    document.getElementById('pt-history-email').textContent = email;
    document.getElementById('pt-history-panel').style.display = 'block';
    switchPtTab('overview');
    loadPtHistory();
}

function closePtHistory() { document.getElementById('pt-history-panel').style.display = 'none'; currentPtEmail = null; }

function switchPtTab(tab) {
    currentPtTab = tab;
    document.querySelectorAll('.pt-tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase() === tab));
    if (currentPtEmail) loadPtHistory();
}

async function loadPtHistory() {
    try {
        const r = await fetch(`/api/patients/${encodeURIComponent(currentPtEmail)}/history`);
        const data = await r.json();
        renderPtTab(data);
    } catch(e) { console.error('loadPtHistory', e); }
}

function renderPtTab(data) {
    const el = document.getElementById('pt-tab-content');
    if (currentPtTab === 'overview') {
        el.innerHTML = `
            <div class="pt-stat-row">
                <div class="pt-stat-card"><strong>${data.appointments?.length||0}</strong><span>Appointments</span></div>
                <div class="pt-stat-card"><strong>${data.visits?.length||0}</strong><span>Visits</span></div>
                <div class="pt-stat-card"><strong>${data.consents?.length||0}</strong><span>Consents</span></div>
                <div class="pt-stat-card"><strong>${data.prescriptions?.length||0}</strong><span>Prescriptions</span></div>
            </div>`;
    } else if (currentPtTab === 'consents') {
        el.innerHTML = data.consents?.length
            ? data.consents.map(c => `<div class="pt-timeline-item"><i class="fas fa-file-signature" style="color:var(--teal);"></i><div><div>${esc(c.signature)}</div><div class="pt-timeline-date">${new Date(c.created_at).toLocaleString()}</div></div></div>`).join('')
            : '<div class="appt-empty">No consents on file</div>';
    } else if (currentPtTab === 'visits') {
        el.innerHTML = data.visits?.length
            ? data.visits.map(v => `<div class="pt-timeline-item"><i class="fas fa-video" style="color:var(--green);"></i><div><div>Room: ${esc(v.room_name)}</div>${v.soap_notes ? `<div style="font-size:12px;color:var(--text-2);">${esc(v.soap_notes.substring(0,120))}${v.soap_notes.length>120?'…':''}</div>` : ''}<div class="pt-timeline-date">${new Date(v.created_at).toLocaleString()}</div></div></div>`).join('')
            : '<div class="appt-empty">No visit records</div>';
    } else if (currentPtTab === 'prescriptions') {
        el.innerHTML = data.prescriptions?.length
            ? data.prescriptions.map(rx => {
                const meds = JSON.parse(rx.medications || '[]');
                return `<div class="pt-timeline-item"><i class="fas fa-prescription-bottle-medical" style="color:#f59e0b;"></i><div><div>Provider: ${esc(rx.provider_name||'—')}</div><div style="font-size:12px;color:var(--text-2);">${meds.map(m=>esc(m.drug)).join(', ')||'No medications listed'}</div><div class="pt-timeline-date">${new Date(rx.created_at).toLocaleString()}</div></div></div>`;
            }).join('')
            : '<div class="appt-empty">No prescriptions on file</div>';
    }
}

function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* Show meeting links after appointment creation */
function showMeetingLinks(data, patientName, patientEmail) {
    const hostLink    = `${location.origin}/?room=${encodeURIComponent(data.room_name)}`;
    const patientLink = `${location.origin}/consent?room=${encodeURIComponent(data.room_name)}&name=${encodeURIComponent(patientName||'')}&email=${encodeURIComponent(patientEmail||'')}${data.token ? '&token=' + data.token : ''}`;
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:3000;display:flex;align-items:center;justify-content:center;padding:16px;';
    modal.innerHTML = `
        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--r-xl);padding:28px;width:100%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,.6);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
                <span style="font-size:1.5rem;color:var(--teal);"><i class="fas fa-circle-check"></i></span>
                <h3 style="margin:0;font-size:1.05rem;">Appointment &amp; Meeting Created</h3>
            </div>
            <p style="font-size:13px;color:var(--text-2);margin:0 0 18px;">The meeting room is ready. Share the patient link or join as host when the time comes.</p>
            <div class="form-group" style="margin-bottom:12px;">
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--teal);">Your Host Link</label>
                <div style="display:flex;gap:8px;">
                    <input type="text" value="${hostLink}" readonly style="flex:1;font-size:12px;color:var(--teal);background:rgba(20,184,166,.06);" onclick="this.select();" />
                    <button onclick="navigator.clipboard.writeText('${hostLink}').then(()=>showToast('Host link copied!'))" style="padding:6px 12px;border-radius:var(--r-sm);border:1px solid var(--border);background:var(--bg);color:var(--text-2);cursor:pointer;"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            ${patientEmail || data.token ? `
            <div class="form-group" style="margin-bottom:20px;">
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#a78bfa;">Patient Consent Link</label>
                <div style="display:flex;gap:8px;">
                    <input type="text" value="${patientLink}" readonly style="flex:1;font-size:12px;color:#a78bfa;background:rgba(167,139,250,.06);" onclick="this.select();" />
                    <button onclick="navigator.clipboard.writeText('${patientLink}').then(()=>showToast('Patient link copied!'))" style="padding:6px 12px;border-radius:var(--r-sm);border:1px solid var(--border);background:var(--bg);color:var(--text-2);cursor:pointer;"><i class="fas fa-copy"></i></button>
                </div>
            </div>` : ''}
            ${data.invite_sent ? '<p style="font-size:12px;color:var(--teal);margin:0 0 18px;"><i class="fas fa-envelope-circle-check"></i> Invite email sent to patient.</p>' : ''}
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <a href="${hostLink}" target="_blank" class="btn-primary" style="padding:9px 18px;gap:6px;text-decoration:none;"><i class="fas fa-video"></i> Join Now</a>
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding:9px 18px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--bg);color:var(--text-2);cursor:pointer;">Close</button>
            </div>
        </div>`;
    document.body.appendChild(modal);
}

/* Show links popup for an existing appointment card */
function showApptLinks(roomName) {
    const appt = allAppts.find(a => a.room_name === roomName);
    const pName  = appt ? appt.patient_name  : '';
    const pEmail = appt ? appt.patient_email : '';
    showMeetingLinks({ room_name: roomName, token: '', invite_sent: false }, pName, pEmail);
}

/* ── Mobile sidebar hamburger toggle ── */
(function() {
    const toggle  = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('admin-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (!toggle || !sidebar || !overlay) return;

    function openSidebar() {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeSidebar() {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    toggle.addEventListener('click', openSidebar);
    overlay.addEventListener('click', closeSidebar);

    /* Close sidebar when a nav item is clicked on mobile */
    sidebar.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (window.innerWidth <= 680) closeSidebar();
        });
    });
})();
</script>

</body>
</html>